<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>2025 Kia K4 GT-Line | Aurora Black Pearl</title>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.167.0/examples/jsm/"
    }
  }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;900&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet"/>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --accent:  #60b8ff;
      --accent2: #38d9ff;
      --bg:      #06060f;
      --muted:   rgba(255,255,255,0.35);
    }

    html, body { width:100%; height:100%; background:var(--bg); overflow:hidden; font-family:'Rajdhani',sans-serif; }

    #canvas-container { position:fixed; inset:0; }
    canvas { display:block; width:100%!important; height:100%!important; }

    #loader {
      position:fixed; inset:0; background:var(--bg);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:20px; z-index:100; transition:opacity 0.8s ease;
    }
    #loader.hidden { opacity:0; pointer-events:none; }
    .loader-title { font-family:'Orbitron',monospace; font-size:clamp(13px,2.5vw,18px); letter-spacing:.35em; color:var(--accent); text-shadow:0 0 20px #60b8ff88; }
    .loader-bar-wrap { width:220px; height:2px; background:rgba(255,255,255,0.08); border-radius:2px; overflow:hidden; }
    .loader-bar { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); width:0%; transition:width 0.3s ease; box-shadow:0 0 10px var(--accent); }
    .loader-pct { font-family:'Orbitron',monospace; font-size:11px; letter-spacing:.2em; color:var(--muted); }

    .ui-top {
      position:fixed; top:0; left:0; right:0; padding:24px 32px;
      display:flex; align-items:flex-start; justify-content:space-between;
      pointer-events:none;
      background:linear-gradient(to bottom,rgba(6,6,15,0.8) 0%,transparent 100%);
    }
    .brand { display:flex; flex-direction:column; gap:4px; }
    .brand-name { font-family:'Orbitron',monospace; font-size:clamp(14px,2.5vw,22px); font-weight:900; letter-spacing:.25em; color:#fff; text-shadow:0 0 40px rgba(96,184,255,0.3); }
    .brand-sub  { font-family:'Orbitron',monospace; font-size:clamp(8px,1.2vw,10px); letter-spacing:.5em; color:var(--accent); opacity:0.8; }
    .ui-stats { display:flex; flex-direction:column; align-items:flex-end; gap:3px; }
    .stat-row { font-family:'Orbitron',monospace; font-size:9px; letter-spacing:.15em; color:var(--muted); }
    .stat-val { color:var(--accent); }

    .speed-panel {
      position:fixed; bottom:0; left:0; right:0; padding:20px 24px 28px;
      background:linear-gradient(to top,rgba(6,6,15,0.95) 0%,transparent 100%);
      display:flex; flex-direction:column; align-items:center; gap:12px;
    }
    .speed-label { font-family:'Orbitron',monospace; font-size:11px; letter-spacing:.25em; color:var(--muted); display:flex; align-items:center; gap:10px; }
    .speed-mph   { color:#fff; font-size:20px; font-weight:600; text-shadow:0 0 16px var(--accent); min-width:40px; text-align:right; }
    .speed-presets { display:flex; gap:8px; }
    .preset-btn {
      background:transparent; border:1px solid rgba(255,255,255,0.12); color:rgba(255,255,255,0.5);
      border-radius:4px; padding:5px 14px; font-family:'Orbitron',monospace; font-size:10px; letter-spacing:.15em; cursor:pointer; transition:all .2s;
    }
    .preset-btn:hover,.preset-btn.active { border-color:var(--accent); color:var(--accent); background:rgba(96,184,255,0.08); box-shadow:0 0 12px rgba(96,184,255,0.15); }
    .speed-slider { width:min(280px,80vw); -webkit-appearance:none; appearance:none; height:2px; background:rgba(255,255,255,0.1); border-radius:2px; outline:none; cursor:pointer; }
    .speed-slider::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent),0 0 20px rgba(96,184,255,0.4); cursor:pointer; transition:transform .15s; }
    .speed-slider::-webkit-slider-thumb:hover { transform:scale(1.3); }

    .hint { position:fixed; bottom:130px; right:24px; font-family:'Rajdhani',sans-serif; font-size:11px; letter-spacing:.1em; color:var(--muted); text-align:right; line-height:1.8; pointer-events:none; }
    .vignette { position:fixed; inset:0; background:radial-gradient(ellipse at center,transparent 45%,rgba(6,6,15,0.7) 100%); pointer-events:none; }
    .corner { position:fixed; width:40px; height:40px; }
    .corner-tl { top:16px;    left:16px;   border-top:1px solid rgba(96,184,255,0.3); border-left:1px solid rgba(96,184,255,0.3); }
    .corner-tr { top:16px;    right:16px;  border-top:1px solid rgba(96,184,255,0.3); border-right:1px solid rgba(96,184,255,0.3); }
    .corner-bl { bottom:90px; left:16px;   border-bottom:1px solid rgba(96,184,255,0.3); border-left:1px solid rgba(96,184,255,0.3); }
    .corner-br { bottom:90px; right:16px;  border-bottom:1px solid rgba(96,184,255,0.3); border-right:1px solid rgba(96,184,255,0.3); }

    @media (max-width:480px) { .ui-stats,.hint { display:none; } }
  </style>
</head>
<body>

<div id="loader">
  <div class="loader-title">LOADING K4 GT-LINE</div>
  <div class="loader-bar-wrap"><div class="loader-bar" id="loader-bar"></div></div>
  <div class="loader-pct" id="loader-pct">0%</div>
</div>

<div id="canvas-container"></div>
<div class="corner corner-tl"></div>
<div class="corner corner-tr"></div>
<div class="corner corner-bl"></div>
<div class="corner corner-br"></div>
<div class="vignette"></div>

<div class="ui-top">
  <div class="brand">
    <div class="brand-name">KIA K4 GT-LINE</div>
    <div class="brand-sub">AURORA BLACK PEARL · 2025</div>
  </div>
  <div class="ui-stats">
    <div class="stat-row">ENGINE &nbsp;<span class="stat-val">2.0L NATURALLY ASPIRATED</span></div>
    <div class="stat-row">OUTPUT &nbsp;<span class="stat-val">147 HP · 132 LB-FT</span></div>
    <div class="stat-row">DRIVE &nbsp;<span class="stat-val">FWD · CVT</span></div>
  </div>
</div>

<div class="hint">DRAG TO ROTATE<br/>SCROLL TO ZOOM</div>

<div class="speed-panel">
  <div class="speed-label">
    AIRFLOW SIMULATION &nbsp;·&nbsp;
    <span class="speed-mph" id="speed-display">40</span>
    &nbsp;MPH
  </div>
  <div class="speed-presets">
    <button class="preset-btn active" data-speed="40">40</button>
    <button class="preset-btn" data-speed="60">60</button>
    <button class="preset-btn" data-speed="80">80</button>
    <button class="preset-btn" data-speed="100">100</button>
  </div>
  <input type="range" class="speed-slider" id="speed-slider" min="40" max="100" step="1" value="40"/>
</div>

<script type="module">
import * as THREE        from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader }    from 'three/addons/loaders/GLTFLoader.js';
import { RGBELoader }    from 'three/addons/loaders/RGBELoader.js';
import { DRACOLoader }   from 'three/addons/loaders/DRACOLoader.js';
import { EffectComposer }  from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass }      from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { OutputPass }      from 'three/addons/postprocessing/OutputPass.js';

// ── Speed state ──────────────────────────────────────────────────
let currentSpeed = 40;
const slider       = document.getElementById('speed-slider');
const speedDisplay = document.getElementById('speed-display');
const presetBtns   = document.querySelectorAll('.preset-btn');
function setSpeed(v) {
  currentSpeed = v; slider.value = v; speedDisplay.textContent = v;
  presetBtns.forEach(b => b.classList.toggle('active', +b.dataset.speed === v));
}
slider.addEventListener('input', () => setSpeed(+slider.value));
presetBtns.forEach(b => b.addEventListener('click', () => setSpeed(+b.dataset.speed)));

// ── Renderer ─────────────────────────────────────────────────────
// FIX 1a: explicit clear colour = scene background
//         Prevents alpha=0 black patches when bloom composites.
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled      = true;
renderer.shadowMap.type         = THREE.PCFSoftShadowMap;
renderer.toneMapping            = THREE.ACESFilmicToneMapping;  // FIX 1b
renderer.toneMappingExposure    = 1.3;
renderer.outputColorSpace       = THREE.SRGBColorSpace;
renderer.setClearColor(0x06060f, 1.0);                          // FIX 1a
document.getElementById('canvas-container').appendChild(renderer.domElement);

// ── Scene & camera ───────────────────────────────────────────────
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x06060f);
scene.fog = new THREE.FogExp2(0x06060f, 0.04);

const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
camera.position.set(5, 2, 5);

const controls = new OrbitControls(camera, renderer.domElement);
Object.assign(controls, {
  enablePan: false, minDistance: 3, maxDistance: 12,
  minPolarAngle: 0.15, maxPolarAngle: Math.PI / 2.1,
  autoRotate: true, autoRotateSpeed: 0.5,
  enableDamping: true, dampingFactor: 0.06,
});

// ── Bloom post-processing ────────────────────────────────────────
// threshold=0.85: only the brightest paint reflections bloom.
// The dark car body and smoke tubes fall below the threshold.
// FIX 1c: single-pass — no layer split, no autoClear mismatch.
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloomPass = new UnrealBloomPass(
  new THREE.Vector2(window.innerWidth, window.innerHeight),
  0.55, 0.40, 0.85   // strength, radius, threshold
);
composer.addPass(bloomPass);
composer.addPass(new OutputPass());

// ── Lighting ─────────────────────────────────────────────────────
scene.add(new THREE.AmbientLight(0xffffff, 0.15));
const sun = new THREE.DirectionalLight(0xffffff, 1.4);
sun.position.set(5, 8, 3);
sun.castShadow = true;
sun.shadow.mapSize.set(2048, 2048);
sun.shadow.camera.near = 0.5; sun.shadow.camera.far = 25;
sun.shadow.camera.left = sun.shadow.camera.bottom = -6;
sun.shadow.camera.right = sun.shadow.camera.top   =  6;
scene.add(sun);
const fill = new THREE.DirectionalLight(0x4488ff, 0.5); fill.position.set(-5, 3, -4); scene.add(fill);
const rim  = new THREE.DirectionalLight(0xffffff,  0.3); rim.position.set( 0, 2, -6); scene.add(rim);

// ── HDRI environment ─────────────────────────────────────────────
// FIX 1d: LinearFilter on env map → no mipmap-edge black seams
function fixEnvTex(t) {
  t.minFilter = THREE.LinearFilter;
  t.magFilter = THREE.LinearFilter;
  t.needsUpdate = true;
}
new RGBELoader().load(
  'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/studio_small_09_1k.hdr',
  (hdr) => { hdr.mapping = THREE.EquirectangularReflectionMapping; fixEnvTex(hdr); scene.environment = hdr; },
  undefined,
  () => {
    const pmrem = new THREE.PMREMGenerator(renderer);
    const t = pmrem.fromScene(new THREE.RoomEnvironment()).texture;
    fixEnvTex(t); scene.environment = t; pmrem.dispose();
  }
);

// ── Ground ───────────────────────────────────────────────────────
const shadowGround = new THREE.Mesh(new THREE.PlaneGeometry(20,20), new THREE.ShadowMaterial({ opacity:0.45 }));
shadowGround.rotation.x = -Math.PI/2; shadowGround.position.y = -0.5; shadowGround.receiveShadow = true;
scene.add(shadowGround);

const reflectFloor = new THREE.Mesh(
  new THREE.PlaneGeometry(20,20),
  new THREE.MeshStandardMaterial({ color:0x0a0a14, metalness:0.4, roughness:0.6, envMapIntensity:0.5 })
);
reflectFloor.rotation.x = -Math.PI/2; reflectFloor.position.y = -0.501;
scene.add(reflectFloor);

// ── Material presets ─────────────────────────────────────────────
const MAT_AURORA = new THREE.MeshStandardMaterial({ color:0x080810, metalness:0.9, roughness:0.08, envMapIntensity:3.0 });
const MAT_CHROME = new THREE.MeshStandardMaterial({ color:0xc0c8d0, metalness:1.0, roughness:0.04, envMapIntensity:3.5 });
const MAT_GLASS  = new THREE.MeshPhysicalMaterial({ color:0x8ab8d8, metalness:0, roughness:0, transmission:0.9, thickness:0.4, transparent:true, opacity:0.25, envMapIntensity:1.5 });
const MAT_RUBBER = new THREE.MeshStandardMaterial({ color:0x111111, metalness:0, roughness:0.95 });

function isWhitish(mat) {
  if (!mat?.color) return false;
  const {r,g,b} = mat.color; return r>0.72 && g>0.72 && b>0.72;
}

// ── Wheel mesh collection ─────────────────────────────────────────
// FIX 2: populated during GLB traverse, rotated each frame
const wheelMeshes = [];

function applyMaterials(model) {
  model.traverse((node) => {
    if (!node.isMesh) return;
    node.castShadow = node.receiveShadow = true;
    const n   = node.name.toLowerCase();
    const mat = Array.isArray(node.material) ? node.material[0] : node.material;

    const isGlass  = ['glass','window','windshield','wind','screen','lens','light','lamp'].some(k => n.includes(k)) || isWhitish(mat);
    const isBody   = ['body','paint','panel','hood','door','fender','roof','trunk','bumper'].some(k => n.includes(k));
    const isChrome = ['chrome','trim','grille','exhaust','mirror'].some(k => n.includes(k));
    const isWheel  = ['wheel','tire','tyre','rim','brake'].some(k => n.includes(k));

    if      (isGlass)  { node.material = MAT_GLASS.clone();  node.renderOrder = 1; }
    else if (isBody)   { node.material = MAT_AURORA.clone(); }
    else if (isChrome) { node.material = MAT_CHROME.clone(); }
    else if (isWheel)  { node.material = MAT_RUBBER.clone(); }

    if (isWheel) wheelMeshes.push(node);  // collect for spin
  });
}

// ── GLB loader ───────────────────────────────────────────────────
const loaderBar = document.getElementById('loader-bar');
const loaderPct = document.getElementById('loader-pct');
const loaderEl  = document.getElementById('loader');

const draco = new DRACOLoader();
draco.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
const gltf = new GLTFLoader();
gltf.setDRACOLoader(draco);
gltf.load('./kiak4.glb',
  (g) => {
    applyMaterials(g.scene);
    g.scene.position.y = -0.5;
    scene.add(g.scene);
    loaderEl.classList.add('hidden');
    setTimeout(() => loaderEl.style.display = 'none', 900);
  },
  (xhr) => {
    if (xhr.lengthComputable) {
      const p = Math.round(xhr.loaded/xhr.total*100);
      loaderBar.style.width = p+'%'; loaderPct.textContent = p+'%';
    }
  },
  (err) => {
    console.error(err);
    loaderPct.textContent = 'MODEL NOT FOUND — place kiak4.glb next to index.html';
    loaderBar.style.background = '#f87171';
  }
);

// ── Smoke shader ─────────────────────────────────────────────────
// FIX 1e: ALL values clamped(0,1) — NaN / Inf mathematically impossible.
// AdditiveBlending: adds light only, NEVER writes black to framebuffer.
const smokeVert = `
  varying vec2 vUv;
  void main(){
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
  }
`;
const smokeFrag = `
  uniform vec3  uColor;
  uniform float uOpacity;
  uniform float uHead;
  varying vec2  vUv;
  void main(){
    float tailLen = 0.70;
    float behind  = uHead - vUv.x;
    if(behind < 0.0) behind += 1.0;
    if(behind > tailLen) discard;

    float along = pow(clamp(1.0 - behind/tailLen, 0.0, 1.0), 1.4);
    float tip   = pow(clamp(1.0 - behind/0.06,   0.0, 1.0), 2.5);
    float core  = pow(clamp(sin(clamp(vUv.y,0.0,1.0)*3.14159265), 0.0, 1.0), 1.8);

    float alpha = clamp((along + tip*0.8)*core*uOpacity, 0.0, 1.0);
    if(alpha < 0.008) discard;

    // Clamp colour — prevents any channel exceeding 1.0 (no NaN possible)
    vec3 col = clamp(mix(uColor, vec3(0.90,0.98,1.00), tip*core*0.65), 0.0, 1.0);
    gl_FragColor = vec4(col*alpha, alpha);   // pre-multiplied for AdditiveBlending
  }
`;

// ── Body silhouette for path deflection ──────────────────────────
const CLEARANCE = 0.022;
function carTopY(pz) {
  if(pz > 3.3 || pz < -3.6) return -99;
  let y;
  if      (pz >  2.5) y = -0.15+(3.3-pz)/0.8*0.28;
  else if (pz >  0.5) y =  0.13+(2.5-pz)/2.0*0.68;
  else if (pz > -0.5) y =  0.81+Math.sin((pz+0.5)/1.0*Math.PI)*0.05;
  else if (pz > -3.1) y =  0.81-(-0.5-pz)/2.6*0.83;
  else                y = -0.02;
  return y + CLEARANCE;
}

// ── Path builder ─────────────────────────────────────────────────
// FIX 3: seedY + 0.20 global lift + vent-zone push of +0.22
//         Width of vent zone broadened (pz 1.6→3.5, x < 0.65)
//         Together these guarantee wands clear the front grille.
function buildWandPath(seedX, seedY, nPts = 24) {
  const baseY = seedY + 0.20;
  const pts = [];
  for(let i = 0; i < nPts; i++){
    const pz = 8.5 - (i/(nPts-1))*14.5;
    let x = seedX, y = baseY;
    const top = carTopY(pz);
    const onCar = top > -90 && Math.abs(seedX) < 0.96;
    const inVent = pz > 1.6 && pz < 3.5 && Math.abs(seedX) < 0.65;
    const ventLift = inVent ? 0.22*Math.sin((pz-1.6)/1.9*Math.PI) : 0;
    if(onCar && y < top+ventLift) y = top+ventLift;
    if(Math.abs(seedX)>0.55 && pz>-3.2 && pz<3.2){
      const arch = 0.09*Math.max(0, Math.sin((3.2-Math.abs(pz))/3.2*Math.PI));
      x = seedX>0 ? seedX+arch : seedX-arch;
    }
    if(pz < -3.3){ const wt=Math.min((-3.3-pz)/3,1); y+=(baseY-y)*wt*0.4; }
    pts.push(new THREE.Vector3(x, y, pz));
  }
  return pts;
}

// ── 16 wand definitions ──────────────────────────────────────────
const WAND_DEFS = [
  {x: 0.00,y: 0.06,r:0.022,op:0.36,spd:0.88}, {x: 0.00,y: 0.22,r:0.016,op:0.28,spd:0.76},
  {x:-0.28,y: 0.07,r:0.018,op:0.32,spd:0.95}, {x: 0.28,y: 0.07,r:0.018,op:0.32,spd:0.82},
  {x:-0.28,y: 0.24,r:0.014,op:0.26,spd:1.05}, {x: 0.28,y: 0.24,r:0.014,op:0.26,spd:0.70},
  {x:-0.58,y: 0.10,r:0.015,op:0.28,spd:0.92}, {x: 0.58,y: 0.10,r:0.015,op:0.28,spd:1.08},
  {x:-0.58,y: 0.26,r:0.012,op:0.22,spd:0.78}, {x: 0.58,y: 0.26,r:0.012,op:0.22,spd:0.85},
  {x:-0.82,y: 0.18,r:0.011,op:0.20,spd:1.12}, {x: 0.82,y: 0.18,r:0.011,op:0.20,spd:0.68},
  {x:-0.20,y: 1.08,r:0.010,op:0.18,spd:0.98}, {x: 0.20,y: 1.08,r:0.010,op:0.18,spd:0.88},
  {x:-0.48,y:-0.28,r:0.010,op:0.20,spd:1.02}, {x: 0.48,y:-0.28,r:0.010,op:0.20,spd:0.75},
];

// ── Build smoke meshes ───────────────────────────────────────────
// 80 tubular segments, 8 radial ≈ 20% fewer triangles vs original 160/10
const smokeWands = WAND_DEFS.map((d, i) => {
  const curve = new THREE.CatmullRomCurve3(buildWandPath(d.x, d.y, 24));
  const geo   = new THREE.TubeGeometry(curve, 80, d.r, 8, false);
  geo.computeBoundingSphere();
  const mat = new THREE.ShaderMaterial({
    vertexShader: smokeVert, fragmentShader: smokeFrag,
    uniforms: { uColor:{value:new THREE.Color(0x30c8ff)}, uOpacity:{value:d.op}, uHead:{value:0} },
    transparent:true, depthWrite:false,
    blending: THREE.AdditiveBlending,   // never produces black
    side: THREE.DoubleSide,
  });
  const mesh = new THREE.Mesh(geo, mat);
  mesh.renderOrder = 2; mesh.frustumCulled = true;
  scene.add(mesh);
  return { mat, phase: i/WAND_DEFS.length, spd: d.spd };
});

// ── Animation loop ───────────────────────────────────────────────
const clock = new THREE.Clock();
function animate() {
  requestAnimationFrame(animate);
  const delta   = clock.getDelta();
  const elapsed = clock.getElapsedTime();

  // Smoke
  const smokeSpd = 0.26 + ((currentSpeed-40)/60)*0.59;
  for(const {mat,phase,spd} of smokeWands)
    mat.uniforms.uHead.value = ((elapsed*smokeSpd*spd)+phase) % 1.0;

  // FIX 2: Wheel spin — rad/s scaled for visual comfort
  // Formula: (mph × 0.44704m/s per mph) / wheelRadius(0.33m) × visualScale(0.008)
  const wRPS = (currentSpeed * 0.44704 / 0.33) * 0.008;
  for(const m of wheelMeshes) m.rotation.x -= wRPS * delta;

  controls.update();
  composer.render();
}
animate();

// ── Resize ───────────────────────────────────────────────────────
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  composer.setSize(window.innerWidth, window.innerHeight);
  bloomPass.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
