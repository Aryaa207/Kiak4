<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>2025 Kia K4 GT-Line | Aero-Visualizer</title>

  <script type="importmap">
  {
    "imports": {
      "three":         "https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.167.0/examples/jsm/"
    }
  }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Rajdhani:wght@300;600&display=swap" rel="stylesheet"/>

  <style>
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
    :root { --accent:#00f2ff; --accent-glow:rgba(0, 242, 255, 0.5); --bg:#020205; }

    html, body { width:100%; height:100%; background:var(--bg); overflow:hidden; font-family:'Rajdhani',sans-serif; }
    #canvas-container { position:fixed; inset:0; z-index: 1; }
    
    /* ── Cinematic Overlay ── */
    .vignette { position:fixed; inset:0; background:radial-gradient(circle, transparent 20%, rgba(0,0,0,0.8) 100%); pointer-events:none; z-index:2; }
    .scanline { position:fixed; inset:0; background:linear-gradient(to bottom, transparent 50%, rgba(0,242,255,0.02) 50%); background-size: 100% 4px; pointer-events:none; z-index:3; }

    /* ── UI ── */
    #loader { position:fixed; inset:0; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; transition:opacity 1s cubic-bezier(0.4, 0, 0.2, 1); }
    #loader.hidden { opacity:0; pointer-events:none; }
    .loader-title { font-family:'Orbitron'; color:var(--accent); letter-spacing:10px; margin-bottom:20px; text-shadow:0 0 15px var(--accent-glow); font-size:14px; }
    .loader-bar-wrap { width:250px; height:2px; background:rgba(255,255,255,0.1); position:relative; }
    .loader-bar { height:100%; background:var(--accent); width:0%; transition:width 0.3s; box-shadow:0 0 10px var(--accent); }

    .ui-top { position:fixed; top:40px; left:40px; z-index:10; pointer-events:none; }
    .brand-name { font-family:'Orbitron'; font-size:24px; font-weight:900; color:#fff; letter-spacing:4px; }
    .brand-sub { color:var(--accent); letter-spacing:8px; font-size:10px; text-transform:uppercase; margin-top:5px; }

    .speed-panel { position:fixed; bottom:40px; left:50%; transform:translateX(-50%); z-index:10; display:flex; flex-direction:column; align-items:center; gap:15px; background:rgba(0,0,0,0.4); padding:20px 40px; border-radius:50px; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); }
    .speed-display { font-family:'Orbitron'; color:#fff; font-size:18px; letter-spacing:2px; }
    .speed-mph { color:var(--accent); font-weight:900; }
    .slider { width:200px; -webkit-appearance:none; height:2px; background:rgba(255,255,255,0.2); outline:none; }
    .slider::-webkit-slider-thumb { -webkit-appearance:none; width:12px; height:12px; background:var(--accent); border-radius:50%; cursor:pointer; box-shadow:0 0 10px var(--accent); }
  </style>
</head>
<body>

<div id="loader">
  <div class="loader-title">SYSTEM INITIALIZING</div>
  <div class="loader-bar-wrap"><div class="loader-bar" id="loader-bar"></div></div>
</div>

<div class="scanline"></div>
<div class="vignette"></div>

<div class="ui-top">
  <div class="brand-name">KIA K4 GT-LINE</div>
  <div class="brand-sub">Aerodynamic Analysis / 2025</div>
</div>

<div id="canvas-container"></div>

<div class="speed-panel">
  <div class="speed-display">VELOCITY: <span class="speed-mph" id="speed-val">40</span> MPH</div>
  <input type="range" class="slider" id="speed-range" min="0" max="120" value="40">
</div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

// ── Configuration ──
const GLB_URL = 'https://aryaa207.github.io/Kiak4/kiak4.glb';
let speed = 40;
const wheelMeshes = [];

// ── Setup Scene ──
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x020205);
scene.fog = new THREE.FogExp2(0x020205, 0.05);

const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 100);
camera.position.set(6, 1.5, 8);

const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.2;
document.getElementById('canvas-container').appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.maxDistance = 15;
controls.minDistance = 4;
controls.maxPolarAngle = Math.PI / 2.1;

// ── Digital Grid Floor ──
const grid = new THREE.GridHelper(100, 100, 0x00f2ff, 0x080815);
grid.position.y = -0.51;
grid.material.opacity = 0.15;
grid.material.transparent = true;
scene.add(grid);

// ── Enhanced Lighting (Studio Style) ──
const mainLight = new THREE.DirectionalLight(0xffffff, 2);
mainLight.position.set(5, 10, 5);
scene.add(mainLight);

const blueFill = new THREE.PointLight(0x00f2ff, 15, 20);
blueFill.position.set(-5, 2, 2);
scene.add(blueFill);

const rearGlow = new THREE.RectAreaLight(0xff0000, 5, 2, 2);
rearGlow.position.set(0, 0.5, -4);
rearGlow.lookAt(0, 0.5, 0);
scene.add(rearGlow);

// ── Material Overhaul (Aurora Black Pearl) ──
const paintMaterial = new THREE.MeshPhysicalMaterial({
  color: 0x050505,
  metalness: 0.9,
  roughness: 0.05,
  clearcoat: 1.0,
  clearcoatRoughness: 0.02,
  reflectivity: 1.0,
  envMapIntensity: 2.5
});

// ── Car Loading Logic ──
const draco = new DRACOLoader();
draco.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
const loader = new GLTFLoader();
loader.setDRACOLoader(draco);

new RGBELoader().load('https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/studio_small_09_1k.hdr', (texture) => {
  texture.mapping = THREE.EquirectangularReflectionMapping;
  scene.environment = texture;

  loader.load(GLB_URL, (gltf) => {
    const model = gltf.scene;
    model.traverse((child) => {
      if (child.isMesh) {
        child.castShadow = true;
        const name = child.name.toLowerCase();
        
        if (name.includes('body') || name.includes('paint')) child.material = paintMaterial;
        if (name.includes('wheel') || name.includes('rim') || name.includes('tire')) wheelMeshes.push(child);
      }
    });
    model.position.y = -0.5;
    scene.add(model);
    document.getElementById('loader').classList.add('hidden');
  }, (xhr) => {
    document.getElementById('loader-bar').style.width = (xhr.loaded / xhr.total * 100) + '%';
  });
});

// ── High-Def Smoke Shader ──
const smokeShader = {
  uniforms: {
    uTime: { value: 0 },
    uSpeed: { value: 1.0 },
    uColor: { value: new THREE.Color(0x00f2ff) }
  },
  vertex: `
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,
  fragment: `
    uniform float uTime;
    uniform vec3 uColor;
    varying vec2 vUv;
    void main() {
      float pulse = sin(vUv.x * 10.0 - uTime * 15.0) * 0.5 + 0.5;
      float fade = smoothstep(0.0, 0.2, vUv.x) * smoothstep(1.0, 0.8, vUv.x);
      float alpha = pulse * fade * 0.4;
      gl_FragColor = vec4(uColor, alpha);
    }
  `
};

// ── Aerodynamic Paths (Adjusted to avoid vents) ──
function createStreamline(x, yOffset) {
  const points = [];
  for (let i = 0; i < 20; i++) {
    const z = 6 - i * 0.6;
    // Basic Aero Curve logic
    let y = yOffset;
    if (z < 3 && z > 0) y += Math.sin((z/3.0) * Math.PI) * 0.4; // Hood arc
    if (z < 0 && z > -3) y += 0.4 - Math.abs(z/3.0) * 0.3; // Roof arc
    points.push(new THREE.Vector3(x, y, z));
  }
  const curve = new THREE.CatmullRomCurve3(points);
  const geo = new THREE.TubeGeometry(curve, 64, 0.015, 8, false);
  const mat = new THREE.ShaderMaterial({
    uniforms: THREE.UniformsUtils.clone(smokeShader.uniforms),
    vertexShader: smokeShader.vertex,
    fragmentShader: smokeShader.fragment,
    transparent: true,
    blending: THREE.AdditiveBlending,
    depthWrite: false
  });
  const mesh = new THREE.Mesh(geo, mat);
  scene.add(mesh);
  return mat;
}

const lines = [
  createStreamline(0, 0.4),    // Center hood
  createStreamline(0.4, 0.35), // Left fender
  createStreamline(-0.4, 0.35),// Right fender
  createStreamline(0.2, 0.8),  // Roof Left
  createStreamline(-0.2, 0.8), // Roof Right
  createStreamline(0.6, 0.2),  // Side mirror level
  createStreamline(-0.6, 0.2)
];

// ── UI Control ──
document.getElementById('speed-range').addEventListener('input', (e) => {
  speed = e.target.value;
  document.getElementById('speed-val').innerText = speed;
});

// ── Render Loop ──
const clock = new THREE.Clock();
function animate() {
  requestAnimationFrame(animate);
  const t = clock.getElapsedTime();
  const delta = clock.getDelta();

  // Rotate wheels proportional to speed
  wheelMeshes.forEach(w => w.rotateX(speed * 0.005));
  
  // Update Shaders
  lines.forEach(l => {
    l.uniforms.uTime.value = t;
    l.uniforms.uSpeed.value = speed / 40;
  });

  controls.update();
  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
